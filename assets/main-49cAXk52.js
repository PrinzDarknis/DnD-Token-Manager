var M=Object.defineProperty;var k=(n,s,e)=>s in n?M(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var u=(n,s,e)=>k(n,typeof s!="symbol"?s+"":s,e);import{L as b,O as o,C as N,D as P}from"./index-DS2GFAHn.js";import{r as d,j as t,c as R}from"./sound-board-CGmrAhx2.js";const $=""+new URL("../trash.svg",import.meta.url).href;function j(n){return Object.entries(n).map(([s,e])=>e?s:"").join(" ")}const O=""+new URL("../icons/d4.svg",import.meta.url).href,H=""+new URL("../icons/d6.svg",import.meta.url).href,L=""+new URL("../icons/d8.svg",import.meta.url).href,V=""+new URL("../icons/d10.svg",import.meta.url).href,U=""+new URL("../icons/d12.svg",import.meta.url).href,A=""+new URL("../icons/d20.svg",import.meta.url).href;function F(n){switch(n){case"D4":return O;case"D6":return H;case"D8":return L;case"D10":return V;case"D12":return U;case"D20":return A;default:return b.warn("diceImg","Unkown Dice Type",n),""}}function B(n,s){const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n)),a=document.createElement("a");a.setAttribute("href",e),a.setAttribute("download",s+".json"),document.body.appendChild(a),a.click(),a.remove()}function D(n,s,e){return Math.min(Math.max(n,s),e)}function C({name:n,ressource:s,gm:e,deleteable:a=!1,onUpdate:r,onDelete:i}){const c=d.useRef(null);function h(p){const E=p.target.checked;s.used=E?s.used+1:s.used-1,s.used=D(s.used,0,s.available),r==null||r(s),p.stopPropagation()}function l(p){const m=s.available+p;if(m<0){a&&e&&confirm(`Delete ${n}?`)&&(i==null||i());return}else if(m>9)return;s.available=m,s.used>s.available&&(s.used=s.available),r==null||r(s)}const f=n.replace(/\s/g,"-"),w=[];for(let p=0;p<s.available;p++)w.push(t.jsx("input",{className:"ressource-slot",type:"checkbox","data-idx":p,checked:p<s.used,onChange:h,onInput:m=>m.stopPropagation()},`ressource-slot-${f}-${p}-${Math.random()}`));return t.jsxs("div",{ref:c,className:"ressource",children:[t.jsx("span",{className:"ressource-name",children:n}),t.jsx("span",{className:"ressource-slots",children:w}),e&&t.jsx("button",{type:"button",className:"new-ressource-mod new-ressource-add",onClick:()=>l(-1),children:"-"}),e&&t.jsx("button",{type:"button",className:"new-ressource-mod new-ressource-sub",onClick:()=>l(1),children:"+"})]})}function G({onCreate:n}){const s=d.useRef(null),e=d.useRef(null);function a(i){i.stopPropagation()}function r(i){var c,h,l,f;return i==null||i.stopPropagation(),i==null||i.preventDefault(),!((c=s.current)!=null&&c.checkValidity())||!((h=s.current)!=null&&h.value)||!((l=e.current)!=null&&l.checkValidity())||!((f=e.current)!=null&&f.value)||(n==null||n({name:s.current.value,resource:{available:Number(e.current.value),used:0}}),s.current.value=s.current.defaultValue,e.current.value=e.current.defaultValue),!1}return t.jsx("div",{className:"new-ressource-component",children:t.jsxs("form",{className:"new-ressource",onInput:a,onSubmit:i=>r(i),children:[t.jsx("input",{ref:s,className:"new-ressource-name",type:"text",defaultValue:"",pattern:".*\\S+.*",minLength:3,maxLength:15,onInput:a}),t.jsx("input",{ref:e,className:"new-ressource-available",type:"number",defaultValue:"1",min:1,max:9,onInput:a}),t.jsx("button",{type:"submit",className:"new-ressource-add",onClick:()=>r(),children:"+"})]})})}const T=""+new URL("../icons/check.svg",import.meta.url).href,J=""+new URL("../icons/settings.svg",import.meta.url).href,K=["D4","D6","D8","D10","D12","D20"],y={},x=class x{static save(s){localStorage.setItem(x.StorageKey,JSON.stringify(s))}static load(){try{const s=localStorage.getItem(x.StorageKey);return s?JSON.parse(s):y}catch{return y}}};u(x,"StorageKey","PersonalSettings");let v=x;function I(n,s=1){const e=Math.random(),a=(c,h)=>`spaceEvenly-${e}-row-${c}-colum-${h}`,r=Math.ceil(n.length/s),i=[];for(let c=0;c<s;c++)i.push([t.jsx("span",{className:"spacer"},a(0,c))]);for(const[c,h]of n.entries()){const l=Math.floor(c/r);i[l].push(h,t.jsx("span",{className:"spacer"},a(c+1,l)))}return t.jsx("div",{className:"even-field",children:i.map((c,h)=>t.jsx("div",{className:"even-row",children:c},a(-1,h)))})}function g({img:n,alt:s,onClick:e,className:a="",active:r=!1,noHover:i=!1}){const c=typeof a=="string"?a:j(a);return t.jsx("button",{type:"button",className:"img-button",onClick:()=>e(),children:t.jsx("img",{src:n,className:j({"img-button-icon":!0,[c]:!0,hoverable:!i,active:r}),alt:s})})}class q extends d.Component{constructor(s){super(s),this.state={index:0}}async componentDidMount(){}async setStatePromise(s){return new Promise(e=>this.setState(s,e))}get index(){return this.state.index}async setIndex(s){await this.setState({...this.state,index:s})}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"tab-manager",children:[t.jsx("div",{className:"tab-selector",children:this.props.tabs.map((s,e)=>t.jsx("div",{className:j({"tab-header":!0,selected:e==this.index}),onClick:()=>this.setIndex(e),children:s.name},`tab-header-${s.name}`))}),t.jsx("div",{className:"tab-area",children:this.props.tabs.map((s,e)=>t.jsx("div",{className:j({"tab-content":!0,left:e<this.index,center:e==this.index,rigth:e>this.index}),children:s.content},`tab-content-${s.name}`))})]})})}}class z extends d.Component{constructor(s){super(s),this.state={mode:"view",editCache:{max:1,type:"D8"}}}async componentDidMount(){}async setStatePromise(s){return new Promise(e=>this.setState(s,e))}get mode(){return this.state.mode}async setMode(s){await this.setStatePromise({...this.state,mode:s})}get editCache(){return this.state.editCache}async setEditCacheMax(s){await this.setStatePromise({...this.state,editCache:{...this.state.editCache,max:s}})}async setEditCacheType(s){await this.setStatePromise({...this.state,editCache:{...this.state.editCache,type:s}})}async clickDice(s){console.debug("Click Dice",s,this.props.character.hitDiceRemaining);let e=s<this.props.character.hitDiceRemaining?this.props.character.hitDiceRemaining-1:this.props.character.hitDiceRemaining+1;e=D(e,0,this.props.character.hitDiceMax),this.props.character.setValue("hitDiceRemaining",e),this.props.onUpdate(this.props.character)}async submitEdit(){this.props.gm&&(this.props.character.setValue("hitDiceMax",this.editCache.max),this.props.character.setValue("hitDice",this.editCache.type),this.props.onUpdate(this.props.character),await this.setMode("view"))}async openEdit(){this.props.gm&&(await this.setEditCacheMax(this.props.character.hitDiceMax),await this.setEditCacheType(this.props.character.hitDice),await this.setMode("edit"))}render(){if(this.mode=="view")return t.jsx(t.Fragment,{children:t.jsx("div",{className:"hit-dice-component",children:t.jsxs("div",{className:"hit-dice-view",children:[t.jsx("span",{className:"hit-dices",children:I(this.renderDice(this.props.character.hitDice,this.props.character.hitDiceMax,this.props.character.hitDiceRemaining),this.props.character.hitDiceMax>10?2:1)}),this.props.gm&&t.jsx(g,{img:J,alt:"edit",onClick:()=>this.openEdit()})]})})});if(this.mode=="edit")return t.jsx(t.Fragment,{children:t.jsx("div",{className:"hit-dice-component",children:t.jsxs("div",{className:"hit-dice-edit",children:[t.jsx("span",{className:"spacer"}),t.jsx("input",{type:"number",className:"hit-dice-number-edit",value:this.editCache.max,onChange:s=>this.setEditCacheMax(Number(s.target.value)),onInput:s=>s.stopPropagation(),min:1,max:20}),t.jsx("select",{name:"hit-dice-type-select",id:"hit-dice-type-select",className:"hit-dice-type-select",value:this.editCache.type,onChange:s=>this.setEditCacheType(s.target.value),onInput:s=>s.stopPropagation(),children:K.map(s=>t.jsx("option",{value:s,children:s},`hit-dice-type-select-option-${s}`))}),t.jsx(g,{img:T,alt:"submit edit",onClick:()=>this.submitEdit()}),t.jsx("span",{className:"spacer"})]})})})}renderDice(s,e,a){const r=[];for(let i=0;i<e;i++)r.push(t.jsx(g,{img:F(s),alt:`Hit Dice ${s}`,onClick:()=>this.clickDice(i),active:i<a,noHover:!0},`hit-dice-button-${i}`));return r}}class Q extends d.Component{constructor(e){super(e);u(this,"hpInputElement",null);u(this,"maxHpInputElement",null);u(this,"maxHpModInputElement",null);u(this,"acInputElement",null)}update(e){var a,r;(r=(a=this.props).onUpdate)==null||r.call(a,e)}onImput(e){const a=e.target,r=a.getAttribute("data-property");if(!r)throw b.error("CharacterComponent","Missing data-property on",a),new Error("data-property was not defined");if(!a.checkValidity()||!a.value){b.debug("CharacterComponent",`invalide input "${a.value}" on`,a);return}this.props.character.setValue(r,a.value.trim()),this.update(this.props.character),e.stopPropagation()}updateResource(e,a){this.props.character.setValue(e,a),this.update(this.props.character)}deleteOtherResource(e){this.props.character.deleteOtherResource(e),this.update(this.props.character)}newResource(e){this.updateResource(`otherResources.${e.name}`,e.resource)}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"character",children:[t.jsxs("form",{onInput:e=>this.onImput(e),onSubmit:e=>(e.stopPropagation(),e.preventDefault(),!1),children:[t.jsxs("div",{className:"character-information",children:[t.jsxs("h1",{className:"name character-information-item",children:[t.jsx("input",{type:"text",defaultValue:this.props.character.name,"data-property":"name",pattern:".*\\S+.*",maxLength:15},`${this.props.character.id}-name`),this.props.gm&&t.jsx("span",{className:"character-delete",children:t.jsx(g,{img:$,alt:"Delete Character",onClick:()=>{var e,a;return(a=(e=this.props).onDelete)==null?void 0:a.call(e)}})})]}),t.jsxs("span",{className:"stats character-information-item",children:[t.jsxs("span",{className:"hp round-box",children:[t.jsx("input",{ref:e=>{this.hpInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.hp,"data-property":"hp",min:0,max:999},`${this.props.character.id}-hp`),t.jsx("span",{className:"devider",children:"/"}),t.jsx("input",{ref:e=>{this.maxHpInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.maxHp,"data-property":"maxHp",min:0,max:999},`${this.props.character.id}-maxHp`),t.jsx("span",{className:"devider",children:"+"}),t.jsx("input",{ref:e=>{this.maxHpModInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.maxHpMod,"data-property":"maxHpMod",max:999},`${this.props.character.id}-maxHpMod`)]}),t.jsx("span",{className:"spacer"}),t.jsx("span",{className:"ac round-box",children:t.jsxs("label",{children:["AC",t.jsx("input",{ref:e=>{this.acInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.ac,"data-property":"ac",min:0,max:99},`${this.props.character.id}-ac`)]})})]})]}),t.jsx("div",{className:"hit-dice-area",children:t.jsx(z,{character:this.props.character,gm:this.props.gm,onUpdate:e=>this.update(e)})}),t.jsxs("div",{className:"resource-list",children:[t.jsx("h2",{children:"Spellslots"}),Object.entries(this.props.character.spellslots).map(([e,a])=>t.jsx(C,{name:`Level ${e}`,gm:this.props.gm,ressource:a,onUpdate:r=>this.updateResource(`spellslots.${e}`,r)},`spellslots-${e}`)),t.jsx("h2",{children:"Other"}),Object.entries(this.props.character.otherResources).map(([e,a])=>t.jsx(C,{name:e,gm:this.props.gm,deleteable:!0,ressource:a,onUpdate:r=>this.updateResource(`otherResources.${e}`,r),onDelete:()=>this.deleteOtherResource(e)},`spellslots-${e}`))]})]}),this.props.gm&&t.jsx(G,{onCreate:e=>this.newResource(e)})]})})}componentDidUpdate(){this.hpInputElement&&this.hpInputElement.value!=`${this.props.character.hp}`&&(this.hpInputElement.value=`${this.props.character.hp}`),this.maxHpInputElement&&this.maxHpInputElement.value!=`${this.props.character.maxHp}`&&(this.maxHpInputElement.value=`${this.props.character.maxHp}`),this.maxHpModInputElement&&this.maxHpModInputElement.value!=`${this.props.character.maxHpMod}`&&(this.maxHpModInputElement.value=`${this.props.character.maxHpMod}`),this.acInputElement&&this.acInputElement.value!=`${this.props.character.ac}`&&(this.acInputElement.value=`${this.props.character.ac}`)}}class W extends d.Component{constructor(e){super(e);u(this,"gmBackup",!1);this.state={chars:{},selected:"",gm:!1}}componentDidMount(){o.isGM().then(e=>this.setGM(e)),o.character.loadAll().then(async e=>{await this.setChars(e),await this.setSelected()}),o.character.registerOnUpdate(async e=>{const a=this.chars[e.id];a&&a.lastUpdate>=e.lastUpdate||await this.setChar(e)},void 0,async e=>{const a=Object.values(this.chars).filter(i=>!e.includes(i.id)).map(i=>i.id),r={...this.chars};for(const i of a)delete r[i];await this.setChars(r)})}async setStatePromise(e){return new Promise(a=>this.setState(e,a))}get chars(){return this.state.chars}async setChars(e){await this.setStatePromise({...this.state,chars:e})}async setChar(e){await this.setChars({...this.chars,[e.id]:e})}get selected(){return this.state.selected}async setSelected(e){var a;e||(e=((a=Object.values(this.chars)[0])==null?void 0:a.id)??""),await this.setStatePromise({...this.state,selected:e})}get gm(){return this.state.gm||this.gmBackup}async setGM(e){await this.setStatePromise({...this.state,gm:e}),this.gmBackup=e}changeSelection(e){this.setSelected(e),o.character.selectedIdTemp=e}updateChar(e){this.setChar(e),o.character.save(e)}async deleteChar(){if(!confirm("Delete Character"))return;const e=this.chars[this.selected],a={...this.chars};delete a[e.id],await this.setChars(a),o.character.delete(e.id),await this.setSelected()}addNewChar(){const e=new N(Object.values(this.chars));this.setChar(e),o.character.save(e),this.changeSelection(e.id)}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"character-manager",children:[t.jsxs("div",{className:"character-selector",children:[Object.values(this.chars).map(e=>t.jsx("button",{className:"character-selector-button",type:"button",onClick:()=>this.changeSelection(e.id),disabled:e.id==this.selected,children:e.name},`select-button-${e.id}`)),this.gm&&t.jsx("button",{className:"character-selector-button",type:"button",onClick:()=>this.addNewChar(),children:"+"})]}),this.chars[this.selected]&&t.jsx(Q,{gm:this.gm,character:this.chars[this.selected],onUpdate:e=>this.updateChar(e),onDelete:()=>this.deleteChar()})]})})}}class X extends d.Component{constructor(e){super(e);u(this,"importFileElement",null);this.state={gm:!1,globalSettings:P,personalSettings:y}}async componentDidMount(){await this.setGM(await o.isGM()),await this.setStatePromise({...this.state,personalSettings:v.load()}),this.gm&&(await this.setStatePromise({...this.state,globalSettings:await o.settings.load()}),o.settings.registerOnUpdate(async e=>{e.lastUpdate>this.state.globalSettings.lastUpdate&&await this.setStatePromise({...this.state,globalSettings:e})}))}async setStatePromise(e){return new Promise(a=>this.setState(e,a))}get gm(){return this.state.gm}async setGM(e){await this.setStatePromise({...this.state,gm:e})}async updateGlobalSettings(e,a){if(!this.gm)return;const r=this.state.globalSettings;r[e]=a,await this.setStatePromise({...this.state,globalSettings:r}),await o.settings.save(r)}async updatePersonalSettings(e,a){const r=this.state.personalSettings;r[e]=a,await this.setStatePromise({...this.state,personalSettings:r}),v.save(r)}async export(){const e=await o.character.loadAll(),a=Object.values(e).map(r=>r.toSimpleObject());B(a,`character-${new Date().toISOString().split("T")[0]}`)}async import(e){var i;const a=(i=e.target.files)==null?void 0:i[0];if(!a)return;const r=new FileReader;r.onload=()=>{try{const c=JSON.parse(r.result);if(!Array.isArray(c))throw new Error(`JSON content is not an array, got ${typeof c}`);const h=c.map(l=>N.restore(l)).filter(l=>!!l);o.character.overwriteAll(h)}catch(c){b.error("SettingsController:import","Error while reading import data",c)}e.target.value=""},r.readAsText(a)}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"settings-controller",children:[t.jsx("fieldset",{className:"personal-settings settings-area",children:t.jsx("legend",{children:t.jsx("h2",{children:"Personal Settings"})})}),this.gm&&t.jsxs("fieldset",{className:"global-settings settings-area",children:[t.jsx("legend",{children:t.jsx("h2",{children:"Global Settings"})}),t.jsxs("fieldset",{children:[t.jsx("legend",{children:t.jsx("h3",{children:"Character"})}),t.jsxs("div",{className:"setting setting-import-export",children:[t.jsx("span",{className:"spacer"}),t.jsx("button",{className:"char-import",type:"button",onClick:()=>{var e;return(e=this.importFileElement)==null?void 0:e.click()},children:"Import"}),t.jsx("span",{className:"spacer"}),t.jsx("button",{className:"char-export",type:"button",onClick:()=>this.export(),children:"Export"}),t.jsx("input",{ref:e=>{this.importFileElement=e},id:"file-upload",type:"file",onChange:e=>this.import(e),hidden:!0}),t.jsx("span",{className:"spacer"})]})]}),t.jsxs("fieldset",{children:[t.jsx("legend",{children:t.jsx("h3",{children:"Plugins"})}),t.jsxs("div",{className:"setting setting-bool",children:[t.jsx("input",{type:"checkbox",checked:this.state.globalSettings["plugin-bubbles"],name:"global-settings-plugin-bubbles",onChange:e=>this.updateGlobalSettings("plugin-bubbles",e.target.checked)}),t.jsx("label",{htmlFor:"global-settings-plugin-bubbles",children:"Stat Bubbles for D&D"})]})]})]})]})})}}const Y=""+new URL("../icons/sound/bau.svg",import.meta.url).href,S=[{name:"Bau Bau",img:Y,file:["Fuwawa  Bau.mp3","Mococo Bau.mp3"]}];class Z extends d.Component{constructor(s){super(s),this.state={iconsPerLine:5}}async componentDidMount(){}async setStatePromise(s){return new Promise(e=>this.setState(s,e))}get iconsPerLine(){return this.state.iconsPerLine}async playSound(s){o.settings.playSound(s)}render(){return t.jsx(t.Fragment,{children:t.jsx("div",{className:"sound-board",children:t.jsxs("fieldset",{className:"personal-settings settings-area",children:[t.jsx("legend",{children:t.jsx("h2",{children:"Sound Board"})}),I(S.map(s=>t.jsx(g,{img:s.img,alt:s.name,onClick:()=>this.playSound(s)},`sound-${s.name}`)),Math.ceil(S.length/this.iconsPerLine))]})})})}}R.createRoot(document.getElementById("root")).render(t.jsx(d.StrictMode,{children:t.jsx(q,{tabs:[{name:"Character",content:t.jsx(W,{})},{name:"⚙",content:t.jsx(X,{})},{name:"𝅘𝅥𝅮",content:t.jsx(Z,{})}]})}));
