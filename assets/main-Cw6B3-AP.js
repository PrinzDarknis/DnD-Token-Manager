var C=Object.defineProperty;var I=(i,s,e)=>s in i?C(i,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[s]=e;var p=(i,s,e)=>I(i,typeof s!="symbol"?s+"":s,e);import{L as f,O as c,C as w,D as E}from"./index-BRWLl5CK.js";import{r as u,j as t,c as $}from"./tab-manager-0omj3t_Y.js";const k=""+new URL("../trash.svg",import.meta.url).href;function y(i){return Object.entries(i).map(([s,e])=>e?s:"").join(" ")}function M(i,s){const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i)),a=document.createElement("a");a.setAttribute("href",e),a.setAttribute("download",s+".json"),document.body.appendChild(a),a.click(),a.remove()}function S({name:i,ressource:s,gm:e,deleteable:a=!1,onUpdate:r,onDelete:n}){const l=u.useRef(null);function d(o){const N=o.target.checked;s.used=N?s.used+1:s.used-1,s.used=Math.min(Math.max(s.used,0),s.available),r==null||r(s),o.stopPropagation()}function h(o){const m=s.available+o;if(m<0){a&&e&&confirm(`Delete ${i}?`)&&(n==null||n());return}else if(m>9)return;s.available=m,s.used>s.available&&(s.used=s.available),r==null||r(s)}const g=i.replace(/\s/g,"-"),v=[];for(let o=0;o<s.available;o++)v.push(t.jsx("input",{className:"ressource-slot",type:"checkbox","data-idx":o,checked:o<s.used,onChange:d,onInput:m=>m.stopPropagation()},`ressource-slot-${g}-${o}-${Math.random()}`));return t.jsxs("div",{ref:l,className:"ressource",children:[t.jsx("span",{className:"ressource-name",children:i}),t.jsx("span",{className:"ressource-slots",children:v}),e&&t.jsx("button",{type:"button",className:"new-ressource-mod new-ressource-add",onClick:()=>h(-1),children:"-"}),e&&t.jsx("button",{type:"button",className:"new-ressource-mod new-ressource-sub",onClick:()=>h(1),children:"+"})]})}function O({onCreate:i}){const s=u.useRef(null),e=u.useRef(null);function a(n){n.stopPropagation()}function r(n){var l,d,h,g;return n==null||n.stopPropagation(),n==null||n.preventDefault(),!((l=s.current)!=null&&l.checkValidity())||!((d=s.current)!=null&&d.value)||!((h=e.current)!=null&&h.checkValidity())||!((g=e.current)!=null&&g.value)||(i==null||i({name:s.current.value,resource:{available:Number(e.current.value),used:0}}),s.current.value=s.current.defaultValue,e.current.value=e.current.defaultValue),!1}return t.jsx("div",{className:"new-ressource-component",children:t.jsxs("form",{className:"new-ressource",onInput:a,onSubmit:n=>r(n),children:[t.jsx("input",{ref:s,className:"new-ressource-name",type:"text",defaultValue:"",pattern:".*\\S+.*",minLength:3,maxLength:15,onInput:a}),t.jsx("input",{ref:e,className:"new-ressource-available",type:"number",defaultValue:"1",min:1,max:9,onInput:a}),t.jsx("button",{type:"submit",className:"new-ressource-add",onClick:()=>r(),children:"+"})]})})}class P extends u.Component{constructor(e){super(e);p(this,"hpInputElement",null);p(this,"maxHpInputElement",null);p(this,"maxHpModInputElement",null);p(this,"acInputElement",null)}update(e){var a,r;(r=(a=this.props).onUpdate)==null||r.call(a,e)}onImput(e){const a=e.target,r=a.getAttribute("data-property");if(!r)throw f.error("CharacterComponent","Missing data-property on",a),new Error("data-property was not defined");if(!a.checkValidity()||!a.value){f.debug("CharacterComponent",`invalide input "${a.value}" on`,a);return}this.props.character.setValue(r,a.value.trim()),this.update(this.props.character),e.stopPropagation()}updateResource(e,a){this.props.character.setValue(e,a),this.update(this.props.character)}deleteOtherResource(e){this.props.character.deleteOtherResource(e),this.update(this.props.character)}newResource(e){this.updateResource(`otherResources.${e.name}`,e.resource)}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"character",children:[t.jsxs("form",{onInput:e=>this.onImput(e),onSubmit:e=>(e.stopPropagation(),e.preventDefault(),!1),children:[t.jsxs("div",{className:"character-information",children:[t.jsxs("h1",{className:"name character-information-item",children:[t.jsx("input",{type:"text",defaultValue:this.props.character.name,"data-property":"name",pattern:".*\\S+.*",maxLength:15},`${this.props.character.id}-name`),this.props.gm&&t.jsx("button",{type:"button",className:"character-delete",onClick:()=>{var e,a;return(a=(e=this.props).onDelete)==null?void 0:a.call(e)},children:t.jsx("img",{src:k,className:"character-delete-icon",alt:"Delete CHaracter"})})]}),t.jsxs("span",{className:"stats character-information-item",children:[t.jsxs("span",{className:"hp round-box",children:[t.jsx("input",{ref:e=>{this.hpInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.hp,"data-property":"hp",min:0,max:999},`${this.props.character.id}-hp`),t.jsx("span",{className:"devider",children:"/"}),t.jsx("input",{ref:e=>{this.maxHpInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.maxHp,"data-property":"maxHp",min:0,max:999},`${this.props.character.id}-maxHp`),t.jsx("span",{className:"devider",children:"+"}),t.jsx("input",{ref:e=>{this.maxHpModInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.maxHpMod,"data-property":"maxHpMod",max:999},`${this.props.character.id}-maxHpMod`)]}),t.jsx("span",{className:"spacer"}),t.jsx("span",{className:"ac round-box",children:t.jsxs("label",{children:["AC",t.jsx("input",{ref:e=>{this.acInputElement=e},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.ac,"data-property":"ac",min:0,max:99},`${this.props.character.id}-ac`)]})})]})]}),t.jsxs("div",{className:"resource-list",children:[t.jsx("h2",{children:"Spellslots"}),Object.entries(this.props.character.spellslots).map(([e,a])=>t.jsx(S,{name:`Level ${e}`,gm:this.props.gm,ressource:a,onUpdate:r=>this.updateResource(`spellslots.${e}`,r)},`spellslots-${e}`)),t.jsx("h2",{children:"Other"}),Object.entries(this.props.character.otherResources).map(([e,a])=>t.jsx(S,{name:e,gm:this.props.gm,deleteable:!0,ressource:a,onUpdate:r=>this.updateResource(`otherResources.${e}`,r),onDelete:()=>this.deleteOtherResource(e)},`spellslots-${e}`))]})]}),this.props.gm&&t.jsx(O,{onCreate:e=>this.newResource(e)})]})})}componentDidUpdate(){this.hpInputElement&&this.hpInputElement.value!=`${this.props.character.hp}`&&(this.hpInputElement.value=`${this.props.character.hp}`),this.maxHpInputElement&&this.maxHpInputElement.value!=`${this.props.character.maxHp}`&&(this.maxHpInputElement.value=`${this.props.character.maxHp}`),this.maxHpModInputElement&&this.maxHpModInputElement.value!=`${this.props.character.maxHpMod}`&&(this.maxHpModInputElement.value=`${this.props.character.maxHpMod}`),this.acInputElement&&this.acInputElement.value!=`${this.props.character.ac}`&&(this.acInputElement.value=`${this.props.character.ac}`)}}const j={},x=class x{static save(s){localStorage.setItem(x.StorageKey,JSON.stringify(s))}static load(){try{const s=localStorage.getItem(x.StorageKey);return s?JSON.parse(s):j}catch{return j}}};p(x,"StorageKey","PersonalSettings");let b=x;class R extends u.Component{constructor(e){super(e);p(this,"gmBackup",!1);this.state={chars:{},selected:"",gm:!1}}componentDidMount(){c.isGM().then(e=>this.setGM(e)),c.character.loadAll().then(async e=>{await this.setChars(e),await this.setSelected()}),c.character.registerOnUpdate(async e=>{const a=this.chars[e.id];a&&a.lastUpdate>=e.lastUpdate||(await this.setChar(e),console.debug("update char",e))},void 0,async e=>{const a=Object.values(this.chars).filter(n=>!e.includes(n.id)).map(n=>n.id),r={...this.chars};for(const n of a)delete r[n];await this.setChars(r)})}async setStatePromise(e){return new Promise(a=>this.setState(e,a))}get chars(){return this.state.chars}async setChars(e){await this.setStatePromise({...this.state,chars:e})}async setChar(e){await this.setChars({...this.chars,[e.id]:e})}get selected(){return this.state.selected}async setSelected(e){var a;e||(e=((a=Object.values(this.chars)[0])==null?void 0:a.id)??""),await this.setStatePromise({...this.state,selected:e})}get gm(){return this.state.gm||this.gmBackup}async setGM(e){await this.setStatePromise({...this.state,gm:e}),this.gmBackup=e}changeSelection(e){this.setSelected(e),c.character.selectedIdTemp=e}updateChar(e){this.setChar(e),c.character.save(e)}async deleteChar(){if(!confirm("Delete Character"))return;const e=this.chars[this.selected],a={...this.chars};delete a[e.id],await this.setChars(a),c.character.delete(e.id),await this.setSelected()}addNewChar(){const e=new w(Object.values(this.chars));this.setChar(e),c.character.save(e),this.changeSelection(e.id)}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"character-manager",children:[t.jsxs("div",{className:"character-selector",children:[Object.values(this.chars).map(e=>t.jsx("button",{className:"character-selector-button",type:"button",onClick:()=>this.changeSelection(e.id),disabled:e.id==this.selected,children:e.name},`select-button-${e.id}`)),this.gm&&t.jsx("button",{className:"character-selector-button",type:"button",onClick:()=>this.addNewChar(),children:"+"})]}),this.chars[this.selected]&&t.jsx(P,{gm:this.gm,character:this.chars[this.selected],onUpdate:e=>this.updateChar(e),onDelete:()=>this.deleteChar()})]})})}}class H extends u.Component{constructor(e){super(e);p(this,"importFileElement",null);this.state={gm:!1,globalSettings:E,personalSettings:j}}async componentDidMount(){await this.setGM(await c.isGM()),await this.setStatePromise({...this.state,personalSettings:b.load()}),this.gm&&(await this.setStatePromise({...this.state,globalSettings:await c.settings.load()}),c.settings.registerOnUpdate(async e=>{e.lastUpdate>this.state.globalSettings.lastUpdate&&await this.setStatePromise({...this.state,globalSettings:e})}))}async setStatePromise(e){return new Promise(a=>this.setState(e,a))}get gm(){return this.state.gm}async setGM(e){await this.setStatePromise({...this.state,gm:e})}async updateGlobalSettings(e,a){if(!this.gm)return;const r=this.state.globalSettings;r[e]=a,await this.setStatePromise({...this.state,globalSettings:r}),await c.settings.save(r)}async updatePersonalSettings(e,a){const r=this.state.personalSettings;r[e]=a,await this.setStatePromise({...this.state,personalSettings:r}),b.save(r)}async export(){const e=await c.character.loadAll(),a=Object.values(e).map(r=>r.toSimpleObject());M(a,`character-${new Date().toISOString().split("T")[0]}`)}async import(e){var n;const a=(n=e.target.files)==null?void 0:n[0];if(!a)return;const r=new FileReader;r.onload=()=>{try{const l=JSON.parse(r.result);if(!Array.isArray(l))throw new Error(`JSON content is not an array, got ${typeof l}`);const d=l.map(h=>w.restore(h)).filter(h=>!!h);c.character.overwriteAll(d)}catch(l){f.error("SettingsController:import","Error while reading import data",l)}e.target.value=""},r.readAsText(a)}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"settings-controller",children:[t.jsx("fieldset",{className:"personal-settings settings-area",children:t.jsx("legend",{children:t.jsx("h2",{children:"Personal Settings"})})}),this.gm&&t.jsxs("fieldset",{className:"global-settings settings-area",children:[t.jsx("legend",{children:t.jsx("h2",{children:"Global Settings"})}),t.jsxs("fieldset",{children:[t.jsx("legend",{children:t.jsx("h3",{children:"Character"})}),t.jsxs("div",{className:"setting setting-import-export",children:[t.jsx("span",{className:"spacer"}),t.jsx("button",{className:"char-import",type:"button",onClick:()=>{var e;return(e=this.importFileElement)==null?void 0:e.click()},children:"Import"}),t.jsx("span",{className:"spacer"}),t.jsx("button",{className:"char-export",type:"button",onClick:()=>this.export(),children:"Export"}),t.jsx("input",{ref:e=>{this.importFileElement=e},id:"file-upload",type:"file",onChange:e=>this.import(e),hidden:!0}),t.jsx("span",{className:"spacer"})]})]}),t.jsxs("fieldset",{children:[t.jsx("legend",{children:t.jsx("h3",{children:"Plugins"})}),t.jsxs("div",{className:"setting setting-bool",children:[t.jsx("input",{type:"checkbox",checked:this.state.globalSettings["plugin-bubbles"],name:"global-settings-plugin-bubbles",onChange:e=>this.updateGlobalSettings("plugin-bubbles",e.target.checked)}),t.jsx("label",{htmlFor:"global-settings-plugin-bubbles",children:"Stat Bubbles for D&D"})]})]})]})]})})}}class D extends u.Component{constructor(s){super(s),this.state={index:0}}async componentDidMount(){}async setStatePromise(s){return new Promise(e=>this.setState(s,e))}get index(){return this.state.index}async setIndex(s){await this.setState({...this.state,index:s})}render(){return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"tab-manager",children:[t.jsx("div",{className:"tab-selector",children:this.props.tabs.map((s,e)=>t.jsx("div",{className:y({"tab-header":!0,selected:e==this.index}),onClick:()=>this.setIndex(e),children:s.name},`tab-header-${s.name}`))}),t.jsx("div",{className:"tab-area",children:this.props.tabs.map((s,e)=>t.jsx("div",{className:y({"tab-content":!0,left:e<this.index,center:e==this.index,rigth:e>this.index}),children:s.content},`tab-content-${s.name}`))})]})})}}$.createRoot(document.getElementById("root")).render(t.jsx(u.StrictMode,{children:t.jsx(D,{tabs:[{name:"Character",content:t.jsx(R,{})},{name:"⚙",content:t.jsx(H,{})}]})}));
