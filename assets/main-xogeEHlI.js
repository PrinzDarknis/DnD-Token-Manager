var P=Object.defineProperty;var L=(n,e,t)=>e in n?P(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var u=(n,e,t)=>L(n,typeof e!="symbol"?e+"":e,t);import{L as j,O as h,C as R,D as $}from"./index-Cr_wPK8R.js";import{j as s,r as d,c as U}from"./sound-board-CVKwAJUx.js";const H=""+new URL("../trash.svg",import.meta.url).href,N=""+new URL("../icons/short-rest.svg",import.meta.url).href,I=""+new URL("../icons/long-rest.svg",import.meta.url).href;function b(n){return Object.entries(n).map(([e,t])=>t?e:"").join(" ")}const O=""+new URL("../icons/d4.svg",import.meta.url).href,V=""+new URL("../icons/d6.svg",import.meta.url).href,A=""+new URL("../icons/d8.svg",import.meta.url).href,F=""+new URL("../icons/d10.svg",import.meta.url).href,G=""+new URL("../icons/d12.svg",import.meta.url).href,B=""+new URL("../icons/d20.svg",import.meta.url).href;function T(n){switch(n){case"D4":return O;case"D6":return V;case"D8":return A;case"D10":return F;case"D12":return G;case"D20":return B;default:return j.warn("diceImg","Unkown Dice Type",n),""}}function J(n,e){const t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n)),a=document.createElement("a");a.setAttribute("href",t),a.setAttribute("download",e+".json"),document.body.appendChild(a),a.click(),a.remove()}function D(n,e,t){return Math.min(Math.max(n,e),t)}const K=""+new URL("../icons/plus.svg",import.meta.url).href,q=""+new URL("../icons/minus.svg",import.meta.url).href;function E(n,e=1){const t=Math.random(),a=(c,o)=>`spaceEvenly-${t}-row-${c}-colum-${o}`,i=Math.ceil(n.length/e),r=[];for(let c=0;c<e;c++)r.push([s.jsx("span",{className:"spacer"},a(0,c))]);for(const[c,o]of n.entries()){const l=Math.floor(c/i);r[l].push(o,s.jsx("span",{className:"spacer"},a(c+1,l)))}return s.jsx("div",{className:"even-field",children:r.map((c,o)=>s.jsx("div",{className:"even-row",children:c},a(-1,o)))})}function p({img:n,alt:e,onClick:t,className:a="",active:i=!1,noHover:r=!1,disabled:c=!1}){const o=typeof a=="string"?a:b(a);return s.jsx("button",{type:"button",className:"img-button",onClick:()=>t(),disabled:c,children:s.jsx("img",{src:n,className:b({"img-button-icon":!0,[o]:!0,hoverable:!r&&!c,active:i}),alt:e})})}class z extends d.Component{constructor(e){super(e),this.state={index:0}}async componentDidMount(){}async setStatePromise(e){return new Promise(t=>this.setState(e,t))}get index(){return this.state.index}async setIndex(e){await this.setState({...this.state,index:e})}render(){return s.jsx(s.Fragment,{children:s.jsxs("div",{className:"tab-manager",children:[s.jsx("div",{className:"tab-selector",children:this.props.tabs.map((e,t)=>s.jsx("div",{className:b({"tab-header":!0,selected:t==this.index}),onClick:()=>this.setIndex(t),children:e.name},`tab-header-${e.name}`))}),s.jsx("div",{className:"tab-area",children:this.props.tabs.map((e,t)=>s.jsx("div",{className:b({"tab-content":!0,left:t<this.index,center:t==this.index,rigth:t>this.index}),children:e.content},`tab-content-${e.name}`))})]})})}}function C({name:n,ressource:e,edit:t,deleteable:a=!1,onUpdate:i,onDelete:r}){const c=d.useRef(null);function o(m){const M=m.target.checked;e.used=M?e.used+1:e.used-1,e.used=D(e.used,0,e.available),i==null||i(e),m.stopPropagation()}function l(m){const g=e.available+m;if(g<0){a&&t&&confirm(`Delete ${n}?`)&&(r==null||r());return}else if(g>9)return;e.available=g,e.used>e.available&&(e.used=e.available),i==null||i(e)}function f(){e.shortReset=!e.shortReset,i==null||i(e)}const k=n.replace(/\s/g,"-"),y=[];for(let m=0;m<e.available;m++)y.push(s.jsx("input",{className:"ressource-slot",type:"checkbox","data-idx":m,checked:m<e.used,onChange:o,onInput:g=>g.stopPropagation()},`ressource-slot-${k}-${m}-${Math.random()}`));return s.jsxs("div",{ref:c,className:"ressource",children:[s.jsx("span",{className:"ressource-name",children:n}),s.jsx("span",{className:"ressource-slots",children:y}),s.jsx(p,{img:e.shortReset?N:I,alt:e.shortReset?"Short Rest":"Long Rest",onClick:()=>f(),disabled:!t},"ressource-rest"),t&&[s.jsx(p,{img:q,alt:"-",onClick:()=>l(-1)},"ressource-sub"),s.jsx(p,{img:K,alt:"+",onClick:()=>l(1)},"ressource-add")]]})}function Q({onCreate:n}){const e=d.useRef(null),t=d.useRef(null);function a(r){r.stopPropagation()}function i(r){var c,o,l,f;return r==null||r.stopPropagation(),r==null||r.preventDefault(),!((c=e.current)!=null&&c.checkValidity())||!((o=e.current)!=null&&o.value)||!((l=t.current)!=null&&l.checkValidity())||!((f=t.current)!=null&&f.value)||(n==null||n({name:e.current.value,resource:{available:Number(t.current.value),used:0,shortReset:!1}}),e.current.value=e.current.defaultValue,t.current.value=t.current.defaultValue),!1}return s.jsx("div",{className:"new-ressource-component",children:s.jsxs("form",{className:"new-ressource",onInput:a,onSubmit:r=>i(r),children:[s.jsx("input",{ref:e,className:"new-ressource-name",type:"text",defaultValue:"",pattern:".*\\S+.*",minLength:3,maxLength:15,onInput:a}),s.jsx("input",{ref:t,className:"new-ressource-available",type:"number",defaultValue:"1",min:1,max:9,onInput:a}),s.jsx("button",{type:"submit",className:"new-ressource-add",onClick:()=>i(),children:"+"})]})})}const W=""+new URL("../icons/check.svg",import.meta.url).href,X=""+new URL("../icons/settings.svg",import.meta.url).href,Y=["D4","D6","D8","D10","D12","D20"],w={},x=class x{static save(e){localStorage.setItem(x.StorageKey,JSON.stringify(e))}static load(){try{const e=localStorage.getItem(x.StorageKey);return e?JSON.parse(e):w}catch{return w}}};u(x,"StorageKey","PersonalSettings");let v=x;class Z extends d.Component{constructor(e){super(e),this.state={mode:"view",editCache:{max:1,type:"D8"}}}async componentDidMount(){}async setStatePromise(e){return new Promise(t=>this.setState(e,t))}get mode(){return this.state.mode}async setMode(e){await this.setStatePromise({...this.state,mode:e})}get editCache(){return this.state.editCache}async setEditCacheMax(e){await this.setStatePromise({...this.state,editCache:{...this.state.editCache,max:e}})}async setEditCacheType(e){await this.setStatePromise({...this.state,editCache:{...this.state.editCache,type:e}})}async clickDice(e){console.debug("Click Dice",e,this.props.character.hitDiceRemaining);let t=e<this.props.character.hitDiceRemaining?this.props.character.hitDiceRemaining-1:this.props.character.hitDiceRemaining+1;t=D(t,0,this.props.character.hitDiceMax),this.props.character.setValue("hitDiceRemaining",t),this.props.onUpdate(this.props.character)}async submitEdit(){this.props.edit&&(this.props.character.setValue("hitDiceMax",this.editCache.max),this.props.character.setValue("hitDice",this.editCache.type),this.props.onUpdate(this.props.character),await this.setMode("view"))}async openEdit(){this.props.edit&&(await this.setEditCacheMax(this.props.character.hitDiceMax),await this.setEditCacheType(this.props.character.hitDice),await this.setMode("edit"))}render(){if(this.mode=="view")return s.jsx(s.Fragment,{children:s.jsx("div",{className:"hit-dice-component",children:s.jsxs("div",{className:"hit-dice-view",children:[s.jsx("span",{className:"hit-dices",children:E(this.renderDice(this.props.character.hitDice,this.props.character.hitDiceMax,this.props.character.hitDiceRemaining),this.props.character.hitDiceMax>10?2:1)}),this.props.edit&&s.jsx(p,{img:X,alt:"edit",onClick:()=>this.openEdit()})]})})});if(this.mode=="edit")return s.jsx(s.Fragment,{children:s.jsx("div",{className:"hit-dice-component",children:s.jsxs("div",{className:"hit-dice-edit",children:[s.jsx("span",{className:"spacer"}),s.jsx("input",{type:"number",className:"hit-dice-number-edit",value:this.editCache.max,onChange:e=>this.setEditCacheMax(Number(e.target.value)),onInput:e=>e.stopPropagation(),min:1,max:20}),s.jsx("select",{name:"hit-dice-type-select",id:"hit-dice-type-select",className:"hit-dice-type-select",value:this.editCache.type,onChange:e=>this.setEditCacheType(e.target.value),onInput:e=>e.stopPropagation(),children:Y.map(e=>s.jsx("option",{value:e,children:e},`hit-dice-type-select-option-${e}`))}),s.jsx(p,{img:W,alt:"submit edit",onClick:()=>this.submitEdit()}),s.jsx("span",{className:"spacer"})]})})})}renderDice(e,t,a){const i=[];for(let r=0;r<t;r++)i.push(s.jsx(p,{img:T(e),alt:`Hit Dice ${e}`,onClick:()=>this.clickDice(r),active:r<a,noHover:!0},`hit-dice-button-${r}`));return i}}class _ extends d.Component{constructor(t){super(t);u(this,"hpInputElement",null);u(this,"maxHpInputElement",null);u(this,"maxHpModInputElement",null);u(this,"acInputElement",null)}update(t){var a,i;(i=(a=this.props).onUpdate)==null||i.call(a,t)}onImput(t){const a=t.target,i=a.getAttribute("data-property");if(!i)throw j.error("CharacterComponent","Missing data-property on",a),new Error("data-property was not defined");if(!a.checkValidity()||!a.value){j.debug("CharacterComponent",`invalide input "${a.value}" on`,a);return}this.props.character.setValue(i,a.value.trim()),this.update(this.props.character),t.stopPropagation()}updateResource(t,a){this.props.character.setValue(t,a),this.update(this.props.character)}deleteOtherResource(t){this.props.character.deleteOtherResource(t),this.update(this.props.character)}newResource(t){this.updateResource(`otherResources.${t.name}`,t.resource)}shortRest(){confirm("Short Rest?")&&(this.props.character.shortRest(),this.update(this.props.character))}longRest(){confirm("long Rest?")&&(this.props.character.longRest(),this.update(this.props.character))}render(){return s.jsx(s.Fragment,{children:s.jsxs("div",{className:"character",children:[s.jsxs("form",{onInput:t=>this.onImput(t),onSubmit:t=>(t.stopPropagation(),t.preventDefault(),!1),children:[s.jsxs("div",{className:"character-information",children:[s.jsxs("h1",{className:"name character-information-item",children:[s.jsx("input",{type:"text",defaultValue:this.props.character.name,"data-property":"name",pattern:".*\\S+.*",maxLength:15},`${this.props.character.id}-name`),s.jsxs("span",{className:"character-actions",children:[s.jsx(p,{img:N,alt:"Short Rest",onClick:()=>this.shortRest()}),s.jsx(p,{img:I,alt:"Long Rest",onClick:()=>this.longRest()}),this.props.edit&&s.jsx(p,{img:H,alt:"Delete Character",onClick:()=>{var t,a;return(a=(t=this.props).onDelete)==null?void 0:a.call(t)}})]})]}),s.jsxs("span",{className:"stats character-information-item",children:[s.jsxs("span",{className:"hp round-box",children:[s.jsx("input",{ref:t=>{this.hpInputElement=t},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.hp,"data-property":"hp",min:0,max:999},`${this.props.character.id}-hp`),s.jsx("span",{className:"devider",children:"/"}),s.jsx("input",{ref:t=>{this.maxHpInputElement=t},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.maxHp,"data-property":"maxHp",min:0,max:999},`${this.props.character.id}-maxHp`),s.jsx("span",{className:"devider",children:"+"}),s.jsx("input",{ref:t=>{this.maxHpModInputElement=t},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.maxHpMod,"data-property":"maxHpMod",max:999},`${this.props.character.id}-maxHpMod`)]}),s.jsx("span",{className:"spacer"}),s.jsx("span",{className:"ac round-box",children:s.jsxs("label",{children:["AC",s.jsx("input",{ref:t=>{this.acInputElement=t},type:"number",className:"input-number-hover-buttons",defaultValue:this.props.character.ac,"data-property":"ac",min:0,max:99},`${this.props.character.id}-ac`)]})})]})]}),s.jsx("div",{className:"hit-dice-area",children:s.jsx(Z,{character:this.props.character,edit:this.props.edit,onUpdate:t=>this.update(t)})}),s.jsxs("div",{className:"resource-list",children:[s.jsx("h2",{children:"Spellslots"}),Object.entries(this.props.character.spellslots).map(([t,a])=>s.jsx(C,{name:`Level ${t}`,edit:this.props.edit,ressource:a,onUpdate:i=>this.updateResource(`spellslots.${t}`,i)},`spellslots-${t}`)),s.jsx("h2",{children:"Other"}),Object.entries(this.props.character.otherResources).map(([t,a])=>s.jsx(C,{name:t,edit:this.props.edit,deleteable:!0,ressource:a,onUpdate:i=>this.updateResource(`otherResources.${t}`,i),onDelete:()=>this.deleteOtherResource(t)},`spellslots-${t}`))]})]}),this.props.edit&&s.jsx(Q,{onCreate:t=>this.newResource(t)})]})})}componentDidUpdate(){this.hpInputElement&&this.hpInputElement.value!=`${this.props.character.hp}`&&(this.hpInputElement.value=`${this.props.character.hp}`),this.maxHpInputElement&&this.maxHpInputElement.value!=`${this.props.character.maxHp}`&&(this.maxHpInputElement.value=`${this.props.character.maxHp}`),this.maxHpModInputElement&&this.maxHpModInputElement.value!=`${this.props.character.maxHpMod}`&&(this.maxHpModInputElement.value=`${this.props.character.maxHpMod}`),this.acInputElement&&this.acInputElement.value!=`${this.props.character.ac}`&&(this.acInputElement.value=`${this.props.character.ac}`)}}const ee=""+new URL("../icons/edit.svg",import.meta.url).href;class te extends d.Component{constructor(e){super(e),this.state={chars:{},selected:"",gm:!1,edit:!1}}async componentDidMount(){await this.setGM(await h.isGM());const e=await h.character.loadAll();await this.setChars(e),await this.setSelected(),await h.character.registerOnUpdate(async t=>{const a=this.chars[t.id];a&&a.lastUpdate>=t.lastUpdate||await this.setChar(t)},void 0,async t=>{const a=Object.values(this.chars).filter(r=>!t.includes(r.id)).map(r=>r.id),i={...this.chars};for(const r of a)delete i[r];await this.setChars(i)})}async setStatePromise(e){return new Promise(t=>this.setState(e,t))}get chars(){return this.state.chars}async setChars(e){await this.setStatePromise({...this.state,chars:e})}async setChar(e){await this.setChars({...this.chars,[e.id]:e})}get selected(){return this.state.selected}async setSelected(e){var t;e||(e=((t=Object.values(this.chars)[0])==null?void 0:t.id)??""),await this.setStatePromise({...this.state,selected:e})}get gm(){return this.state.gm}async setGM(e){await this.setStatePromise({...this.state,gm:e})}get edit(){return this.state.edit}async setEdit(e){await this.setStatePromise({...this.state,edit:e})}changeSelection(e){this.setSelected(e)}async updateChar(e){await this.setChar(e),h.character.save(e)}async deleteChar(){if(!confirm("Delete Character"))return;const e=this.chars[this.selected],t={...this.chars};delete t[e.id],await this.setChars(t),h.character.delete(e.id),await this.setSelected()}addNewChar(){const e=new R(Object.values(this.chars));this.setChar(e),h.character.save(e),this.changeSelection(e.id)}render(){return s.jsx(s.Fragment,{children:s.jsxs("div",{className:"character-manager",children:[s.jsxs("div",{className:"header",children:[s.jsxs("div",{className:"character-selector",children:[Object.values(this.chars).map(e=>s.jsx("button",{className:"character-selector-button",type:"button",onClick:()=>this.changeSelection(e.id),disabled:e.id==this.selected,children:e.name},`select-button-${e.id}`)),this.edit&&s.jsx("button",{className:"character-selector-button",type:"button",onClick:()=>this.addNewChar(),children:"+"})]}),this.gm&&s.jsx(p,{img:ee,alt:"Edit",onClick:()=>this.setEdit(!this.edit),active:this.edit})]}),this.chars[this.selected]&&s.jsx(_,{edit:this.edit,character:this.chars[this.selected],onUpdate:e=>this.updateChar(e),onDelete:()=>this.deleteChar()})]})})}}class se extends d.Component{constructor(t){super(t);u(this,"importFileElement",null);this.state={gm:!1,globalSettings:$,personalSettings:w}}async componentDidMount(){await this.setGM(await h.isGM()),await this.setStatePromise({...this.state,personalSettings:v.load()}),this.gm&&(await this.setStatePromise({...this.state,globalSettings:await h.settings.load()}),h.settings.registerOnUpdate(async t=>{t.lastUpdate>this.state.globalSettings.lastUpdate&&await this.setStatePromise({...this.state,globalSettings:t})}))}async setStatePromise(t){return new Promise(a=>this.setState(t,a))}get gm(){return this.state.gm}async setGM(t){await this.setStatePromise({...this.state,gm:t})}async updateGlobalSettings(t,a){if(!this.gm)return;const i=this.state.globalSettings;i[t]=a,await this.setStatePromise({...this.state,globalSettings:i}),await h.settings.save(i)}async updatePersonalSettings(t,a){const i=this.state.personalSettings;i[t]=a,await this.setStatePromise({...this.state,personalSettings:i}),v.save(i)}async export(){const t=await h.character.loadAll(),a=Object.values(t).map(i=>i.toSimpleObject());J(a,`character-${new Date().toISOString().split("T")[0]}`)}async import(t){var r;const a=(r=t.target.files)==null?void 0:r[0];if(!a)return;const i=new FileReader;i.onload=()=>{try{const c=JSON.parse(i.result);if(!Array.isArray(c))throw new Error(`JSON content is not an array, got ${typeof c}`);const o=c.map(l=>R.restore(l)).filter(l=>!!l);h.character.overwriteAll(o)}catch(c){j.error("SettingsController:import","Error while reading import data",c)}t.target.value=""},i.readAsText(a)}render(){return s.jsx(s.Fragment,{children:s.jsxs("div",{className:"settings-controller",children:[s.jsx("fieldset",{className:"personal-settings settings-area",children:s.jsx("legend",{children:s.jsx("h2",{children:"Personal Settings"})})}),this.gm&&s.jsxs("fieldset",{className:"global-settings settings-area",children:[s.jsx("legend",{children:s.jsx("h2",{children:"Global Settings"})}),s.jsxs("fieldset",{children:[s.jsx("legend",{children:s.jsx("h3",{children:"Character"})}),s.jsxs("div",{className:"setting setting-import-export",children:[s.jsx("span",{className:"spacer"}),s.jsx("button",{className:"char-import",type:"button",onClick:()=>{var t;return(t=this.importFileElement)==null?void 0:t.click()},children:"Import"}),s.jsx("span",{className:"spacer"}),s.jsx("button",{className:"char-export",type:"button",onClick:()=>this.export(),children:"Export"}),s.jsx("input",{ref:t=>{this.importFileElement=t},id:"file-upload",type:"file",onChange:t=>this.import(t),hidden:!0}),s.jsx("span",{className:"spacer"})]})]}),s.jsxs("fieldset",{children:[s.jsx("legend",{children:s.jsx("h3",{children:"Plugins"})}),s.jsxs("div",{className:"setting setting-bool",children:[s.jsx("input",{type:"checkbox",checked:this.state.globalSettings["plugin-bubbles"],name:"global-settings-plugin-bubbles",onChange:t=>this.updateGlobalSettings("plugin-bubbles",t.target.checked)}),s.jsx("label",{htmlFor:"global-settings-plugin-bubbles",children:"Stat Bubbles for D&D"})]})]})]})]})})}}const ae=""+new URL("../icons/sound/bau.svg",import.meta.url).href,ie=""+new URL("../icons/sound/fox.svg",import.meta.url).href,re=""+new URL("../icons/sound/dog.svg",import.meta.url).href,ne=""+new URL("../icons/sound/scream.svg",import.meta.url).href,ce=""+new URL("../icons/sound/secret.svg",import.meta.url).href,oe=""+new URL("../icons/sound/gift.svg",import.meta.url).href,he=""+new URL("../icons/sound/chokobo.svg",import.meta.url).href,le=""+new URL("../icons/sound/!.svg",import.meta.url).href,pe=""+new URL("../icons/sound/goose.svg",import.meta.url).href,me=""+new URL("../icons/sound/victory.svg",import.meta.url).href,S=[{name:"Bau Bau",img:ae,file:["Fuwawa  Bau.mp3","Mococo Bau.mp3"]},{name:"Fox",img:ie,file:"fox.mp3"},{name:"Dog",img:re,file:"bark.mp3"},{name:"Scream",img:ne,file:"scream.mp3"},{name:"Secret",img:ce,file:"secret.mp3"},{name:"Got Item",img:oe,file:"got item.mp3"},{name:"Chokobo",img:he,file:"chokobo.mp3"},{name:"!",img:le,file:"!.mp3"},{name:"Honk",img:pe,file:"honk.mp3"},{name:"Victory",img:me,file:"victory.mp3"}];class de extends d.Component{constructor(e){super(e),this.state={iconsPerLine:5}}async componentDidMount(){}async setStatePromise(e){return new Promise(t=>this.setState(e,t))}get iconsPerLine(){return this.state.iconsPerLine}async playSound(e){h.settings.playSound(e)}render(){return s.jsx(s.Fragment,{children:s.jsx("div",{className:"sound-board",children:s.jsxs("fieldset",{className:"personal-settings settings-area",children:[s.jsx("legend",{children:s.jsx("h2",{children:"Sound Board"})}),E(S.map(e=>s.jsx(p,{img:e.img,alt:e.name,onClick:()=>this.playSound(e)},`sound-${e.name}`)),Math.ceil(S.length/this.iconsPerLine))]})})})}}U.createRoot(document.getElementById("root")).render(s.jsx(d.StrictMode,{children:s.jsx(z,{tabs:[{name:"Character",content:s.jsx(te,{})},{name:"⚙",content:s.jsx(se,{})},{name:"𝅘𝅥𝅮",content:s.jsx(de,{})}]})}));
